# Mocking & Scenarios

> Web-only docs page. Use `npm run storybook` and open http://localhost:7007.

import { Meta, Canvas, Story, Controls } from '@storybook/blocks';

<Meta title="Docs/Mocking & Scenarios" />

# Mocking & Scenarios

This page summarizes how our stories use HTTP mocks (MSW) and WebSocket mock scenarios.

- API Playground story exercises HTTP endpoints via MSW.
- Live Task Board story demonstrates a real-time feed via the WebSocket mock.
- The WS Scenario toolbar lets you switch deterministic scenarios on the fly.

## HTTP mocking (MSW)

Handlers:

- GET /api/lessons, GET /api/quizzes: sample data
- GET /api/cache: ETag + Cache-Control; call twice → 304
- GET /api/ratelimit: multiple calls → 429 with Retry-After
- POST /api/login: mock token
- POST /api/tooltips/generate: special triggers in the `input` body
  - TRIGGER_RATE_LIMIT → 429 with Retry-After
  - TRIGGER_ERROR → 500 error
  - TRIGGER_CACHED → 200 with ETag; next call → 304

## WebSocket scenarios

Use the WS Scenario toolbar (top in Storybook):

- lobbyBasic (default)
- matchHappyPath (fast countdown + questions)
- disconnectRecovery (brief disconnect)
- taskBoardLive (periodic task:update events)

Live Task Board is pre-configured with `globals: { wsScenario: 'taskBoardLive' }`.

## Try it

### API Playground

<Canvas>
  <Story id="api-playground--default" />
</Canvas>

Tips:

- Switch endpoints in the dropdown
- For tooltips, type TRIGGER\_\* words into the input

### Live Task Board

<Canvas>
  <Story id="live-taskboard--default" />
</Canvas>

Use the WS toolbar to switch scenarios.

### Live WS → SSE fallback (real SSE)

- Start SSE server in another terminal: `npm run sse:demo` (serves http://localhost:3002/api/sse-demo)
- Or run both Storybook + SSE at once: `npm run storybook:with-sse`
- Then open the WS→SSE fallback demo:

<Canvas>
  <Story id="live-ws-sse-fallback--default" />
</Canvas>

## Where to find things

- HTTP mocks (MSW): src/mocks/handlers.ts; wired in .storybook/preview.ts
- Per-story overrides: see ApiPlayground story parameters (msw.handlers)
- Global defaults: “MSW Profile” toolbar; control endpoints /**msw**/defaults
- Disable defaults per-request: set header `x-msw-no-defaults: 1` (NetworkPlayground has a toggle)
- Per-story no-defaults: set story parameter `mswNoDefaults: true` to auto-inject the header via fetch wrapper
- Defaults chip: small pill showing current latency/error; used in API/Playground
- WebSocket mock: src/services/mockWebSocket.ts; scenario via WS toolbar or WS_MOCK_SCENARIO
- API docs: API/Swagger story renders public/swagger.json
- Live demos: Live/TaskBoard (WS), Live/WS SSE Fallback (SSE)
- Repo docs: Docs/Repo Docs Browser reads Markdown from /docs; Docs/Quick Index lists the most-used files
- Flags: USE_MOCKS, EXPO_PUBLIC_USE_MSW, EXPO_PUBLIC_USE_WS_MOCKS, EXPO_PUBLIC_USE_ALL_MOCKS

## Related documentation

- Local guide: docs/status/LOCAL_DEV_AND_TESTING_GUIDE.md
- Storybook + MSW Testing: docs/STORYBOOK_TESTING.md
- WS API: docs/WEBSOCKET_API.md
- WS Mocks: docs/mocks/WEBSOCKET_MOCKS.md
- Service Mocking Architecture: docs/mocks/SERVICE_MOCKING_ARCHITECTURE.md
