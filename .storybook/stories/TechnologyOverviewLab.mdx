import { Meta } from '@storybook/blocks';

# Technology Overview Lab

<Meta title="Labs/Technology Overview Lab" />

Welcome to the Technology Overview Lab for QuizMentor. This lab helps you:
- Understand the stack and where each technology is used in this repo
- Jump into live stories (Swagger/API, Journeys, S2S) and docs
- Run hands-on exercises with MSW and WebSocket scenarios (toolbar controls)

Tip: Use the toolbar at the top of Storybook
- WS Scenario: choose realtime mock scenarios (lobbyBasic, matchHappyPath, etc.)
- MSW Profile: set latency/error profiles (default, slower, flaky, chaos)
- Theme/Platform: switch visual tokens

## Quickstart (5–10 minutes)
- 1) API: Open [API/Swagger](?path=/story/api-swagger--default), set docExpansion to full, and try an endpoint.
- 2) Network: Switch MSW Profile to "flaky" and re-run any API story; observe React Query retries.
- 3) Realtime: Set WS Scenario to "matchHappyPath" and open “Quiz/Quiz Engine Sandbox” and “Network Playground”.
- 4) Journeys: Open [Journeys/User Journey Map](?path=/story/analytics-user-journey-map--default) and traverse linked stories.
- 5) S2S: Open [S2S Architecture](?path=/story/architecture-s2s-service-mesh--architecture-overview) and “Dashboard/S2S Architecture”.
- 6) Docs: Open [Repo Docs Browser](?path=/story/docs-repo-docs-browser--default) and load TECH_STACK_CHEAT_SHEET.md.

Section Index
- [Project Card](#project-card)
- [Stack Overview](#stack-overview)
- [Examples by Technology](#examples-by-technology)
- [User Stories Tie-in](#user-stories-tie-in)
- [S2S (System-to-System) Orchestration](#s2s-system-to-system-orchestration)
- [Hands-on Lab Exercises](#hands-on-lab-exercises)
- [References](#references)

---

## Project Card

- Project: QuizMentor
- Repo/Path: NatureQuest/QuizMentor
- Overview: Gamified learning app with Expo/React Native (plus web) and an Express API, documented via Storybook labs with Swagger and MSW.

---

## Stack Overview

- Frontend
  - React 19, React Native 0.79, Expo 53, React Native Web
  - Expo Router; React Navigation (stack, tabs, gesture-handler, screens, safe-area-context)
  - State/Data: Zustand, TanStack React Query 5
  - Styling: NativeWind + Tailwind 3
  - UI/UX: Lottie, react-native-toast-message
  - Networking/Realtime: axios, Socket.IO client, SSE demo
  - Storage: react-native-mmkv
  - Expo modules: notifications, av, haptics, device, constants, etc.
- Backend
  - Node.js 20, Express, cors, helmet, express-rate-limit
  - Redis (ioredis), Sentry, PostHog
  - supabase-js (server), zod (validation)
- Services
  - Supabase (auth/db), Socket.IO client abstraction, in-app analytics queue
- Infra
  - Docker Compose 3.8 (PostgreSQL 15, Redis 7), Locust 2.17
- Testing
  - Jest + jest-expo, Testing Library, MSW, Playwright, Detox, @axe-core/playwright
  - Storybook Test Runner + @storybook/test
- Docs
  - Storybook (react-vite), Swagger UI React (OpenAPI), react-markdown + remark-gfm, Chromatic

---

## Examples by Technology

### React Navigation (Stack)
```tsx path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/AppWithNav.tsx start=39
<NavigationContainer>
  <Stack.Navigator
    initialRouteName="Home"
    screenOptions={{
      headerStyle: { backgroundColor: '#3b82f6' },
      headerTintColor: '#fff',
      headerTitleStyle: { fontWeight: 'bold' },
    }}
  >
    <Stack.Screen name="Home" component={HomeScreen} options={{ title: 'QuizMentor' }} />
    <Stack.Screen name="Test" component={TestScreen} options={{ title: 'Test' }} />
  </Stack.Navigator>
</NavigationContainer>
```

- Learn more: Journeys and flows under “Flows” and “Journeys” stories.

### TanStack React Query (Client caching)
```ts path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/src/services/api/queryClient.ts start=18
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,
      gcTime: 10 * 60 * 1000,
      retry: (failureCount, error) => {
        if (error instanceof APIError) {
          if (error.statusCode >= 400 && error.statusCode < 500 && error.statusCode !== 429) {
            return false;
          }
        }
        return failureCount < 3;
      },
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
      refetchOnWindowFocus: true,
      refetchOnReconnect: 'always',
      networkMode: 'online',
    },
  },
});
```

- See also: providers/QueryProvider.tsx for toasts and cache hooks.

### Zustand (Local game session)
```ts path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/src/stores/gameStore.ts start=42
export const useGameStore = create<State & Actions>((set, get) => ({
  session: null,
  questions: [],
  start: (topic, difficulty) => {
    const questions = dummyQuestions(topic, difficulty);
    const session = createSession({ topic, difficulty, questions });
    set({ session, questions });
  },
  answer: (selectedIndex: number) => {
    const { session } = get();
    if (!session) return;
    set({ session: answerCurrent(session, selectedIndex) });
  },
  next: () => {
    const { session, questions } = get();
    if (!session) return;
    set({ session: next(session, questions) });
  },
  reset: () => set({ session: null, questions: [] }),
}));
```

### Supabase (Client)
```ts path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/src/lib/supabase.ts start=110
export const supabase = createClient<Database>(supabaseUrl || '', supabaseAnonKey || '', {
  auth: {
    storage: getStorage(),
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
  global: { headers: { 'x-platform': Platform.OS } },
});
```

### Socket.IO Client (Mockable)
```ts path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/src/lib/socket.ts start=77
export function createSocket(url: string, options?: any): any {
  if (USE_WS_MOCKS) {
    return new MockSocket(url, options);
  }
  const { io } = require('socket.io-client');
  return io(url, options);
}
```

- Try: Use WS Scenario toolbar control to switch realtime demos.

### Storybook + MSW initialization
```tsx path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/.storybook/preview.tsx start=4
import { initialize, mswDecorator } from 'msw-storybook-addon';
import { handlers } from '../src/mocks/handlers';
import storybookHandlers from '../src/mocks/handlers.storybook';

// Initialize MSW addon
initialize({ onUnhandledRequest: 'bypass' });
```

### Swagger UI React (OpenAPI)
```tsx path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/src/stories/Swagger.stories.tsx start=30
<SwaggerUI
  url="/docs/api-specs/openapi/quizmentor-api-v1.yaml"
  docExpansion={args.docExpansion}
  defaultModelsExpandDepth={args.defaultModelsExpandDepth}
  defaultModelExpandDepth={args.defaultModelExpandDepth}
  defaultModelRendering={args.defaultModelRendering}
  filter={args.filter}
  displayOperationId={args.displayOperationId}
  persistAuthorization={args.persistAuthorization}
/>
```

- Open the API doc story: [API/Swagger](?path=/story/api-swagger--default)

### Jest (Unit/Integration)
```js path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/jest.config.js start=1
module.exports = {
  preset: 'jest-expo',
  setupFilesAfterEnv: [
    '<rootDir>/jest.setup.js',
    '<rootDir>/tests/setup.ts',
    '@testing-library/jest-native/extend-expect',
  ],
```

### Playwright (Web E2E)
```ts path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/playwright.config.ts start=45
webServer: {
  command: CMD_PREFIX,
  url: 'http://localhost:3003',
  reuseExistingServer: !process.env.CI,
  timeout: 120 * 1000,
},
```

### Detox (Native E2E)
```js path=/Users/betolbook/Documents/github/NatureQuest/QuizMentor/.detoxrc.js start=1
module.exports = {
  testRunner: {
    args: { $0: 'jest', config: 'e2e/jest.config.js' },
    jest: { setupFilesAfterEnv: ['<rootDir>/e2e/jest.setup.js'] },
  },
  apps: { 'ios.debug': { type: 'ios.app', binaryPath: 'ios/build/.../QuizMentor.app', build: 'xcodebuild ...' } },
  devices: { simulator: { type: 'ios.simulator', device: { type: 'iPhone 14' } } },
  configurations: { 'ios.sim.debug': { app: 'ios.debug', device: 'simulator' } },
};
```

---

## User Stories Tie-in

- Journeys:
  - Explore story: “Journeys/UserJourneyMap” → [Open](?path=/story/journeys-userjourneymap--default)
  - Explore catalog: “Specs/Journeys Detailed” → [Open](?path=/story/specs-journeys-detailed--page)
- Flows:
  - “Flows/Quick Index” and “Flows” narratives map category→screen→service touches
  - Try toggling MSW Profile to simulate network conditions for each flow
- Auth + Profiles:
  - Stories: “Auth Smoke”, “Auth MSW Flow”; Docs: AUTHENTICATION_DESIGN.md
- Leaderboard + Gamification:
  - Stories: “Gamification System”, “Leaderboard Screen”; Docs: enhancedGamification services

---

## S2S (System-to-System) Orchestration

- Architecture & Dashboards:
  - “S2S/S2S Architecture” → [Open](?path=/story/s2s-s2sarchitecture--default)
  - “S2S/S2S Dashboard” → [Open](?path=/story/s2s-s2sdashboard--default)
  - “Specs/S2S” (full narrative) → [Open](?path=/story/specs-s2s--page)
- API Gateway & Validation:
  - Express + helmet + rate-limit in api/src/index.ts; OpenAPI served via Storybook
  - Swagger: [Open API Doc](?path=/story/api-swagger--default)
- Realtime:
  - Use WS Scenario toolbar to simulate lobby/match/disconnect flows

---

## Hands-on Lab Exercises

1) Explore the API
- Open [API/Swagger](?path=/story/api-swagger--default)
- Try “docExpansion: full” and enable “Try It Out”
- Follow links to Repo Docs Browser → [Docs/Repo Docs Browser](?path=/story/docs-repo-docs-browser--default)

2) Simulate Network Conditions (MSW)
- Set MSW Profile → flaky or chaos
- Open “Testing/E2E Test Dashboard” and observe retry/backoff in React Query

3) Realtime Scenarios (WS)
- Choose WS Scenario → “matchHappyPath”
- Open “Quiz/Quiz Engine Sandbox” and “Network Playground” to see events

4) Journeys Mapping
- Open “Journeys/User Journey Map” and then visit stories referenced from each node
- Cross-check docs: docs/status/TECH_STACK_CHEAT_SHEET.md

5) End-to-End
- Web: run Playwright against Expo web (see playwright.config.ts notes)
- Native: run Detox basic journey (see e2e/detox/*.e2e.ts)

---

## References

- Storybook Start: [Start Here](?path=/story/start-here--page)
- Tech Stack & API: [Tech Stack & API](?path=/story/tech-stack-and-api--page)
- Repo Docs Browser: [Docs/Repo Docs Browser](?path=/story/docs-repo-docs-browser--default)
- Swagger UI: [API/Swagger](?path=/story/api-swagger--default)
- OpenAPI Spec: /docs/api-specs/openapi/quizmentor-api-v1.yaml
- Architecture narratives: .storybook/stories/* (Overview, Architecture, Specs)

