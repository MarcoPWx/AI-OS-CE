apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: quizmentor-gateway
  namespace: quizmentor-app
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "quizmentor.local"
    - "*.quizmentor.local"
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: quizmentor-vs
  namespace: quizmentor-app
spec:
  hosts:
  - "quizmentor.local"
  - "*.quizmentor.local"
  gateways:
  - quizmentor-gateway
  http:
  - match:
    - uri:
        prefix: "/api/v1/learning"
    route:
    - destination:
        host: learning-orchestrator
        port:
          number: 3010
      weight: 100
  - match:
    - uri:
        prefix: "/api/v1/adaptive"
    route:
    - destination:
        host: adaptive-engine
        port:
          number: 3011
      weight: 100
  - match:
    - uri:
        prefix: "/api/v1/bloom"
    route:
    - destination:
        host: bloom-validator
        port:
          number: 3012
      weight: 100
  - match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: quizmentor-gateway
        port:
          number: 8080
      weight: 100
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: learning-orchestrator-dr
  namespace: quizmentor-app
spec:
  host: learning-orchestrator
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    loadBalancer:
      simple: ROUND_ROBIN
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: adaptive-engine-dr
  namespace: quizmentor-app
spec:
  host: adaptive-engine
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    loadBalancer:
      simple: ROUND_ROBIN
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: bloom-validator-dr
  namespace: quizmentor-app
spec:
  host: bloom-validator
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    loadBalancer:
      simple: ROUND_ROBIN
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: quizmentor-gateway-dr
  namespace: quizmentor-app
spec:
  host: quizmentor-gateway
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
      http:
        http1MaxPendingRequests: 200
        http2MaxRequests: 200
        maxRequestsPerConnection: 2
    loadBalancer:
      simple: ROUND_ROBIN
    outlierDetection:
      consecutiveErrors: 10
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
