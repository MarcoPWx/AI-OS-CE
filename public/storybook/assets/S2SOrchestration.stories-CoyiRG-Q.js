import{r as i,R as t}from"./index-R2V08a_e.js";import{D as Z}from"./DefaultsChip-CQdNt6TR.js";import{w as G,u as D,e as h}from"./index-C-PFODCg.js";function v({label:o,children:r}){return t.createElement("label",{style:{display:"flex",gap:8,alignItems:"center"}},t.createElement("div",{style:{width:120,fontSize:12,opacity:.8}},o),t.createElement("div",null,r))}function ee(){const[o,r]=i.useState("math"),[l,k]=i.useState("medium"),[b,R]=i.useState(!1),[m,I]=i.useState("none"),[u,P]=i.useState(0),[p,L]=i.useState(0),[C,j]=i.useState(!1),[M,F]=i.useState(0),[N,H]=i.useState(!1),[K,J]=i.useState(null),[n,O]=i.useState(null),[g,w]=i.useState(null);t.useEffect(()=>{try{const e=new URLSearchParams(window.location.search),a=e.get("traceFail");a&&["none","recommendations","session","validate"].includes(a)&&I(a);const c=Number(e.get("traceDelay")||"0");Number.isNaN(c)||P(Math.max(0,Math.min(1e4,c)));const s=e.get("noDefaults");(s==="1"||s==="true")&&R(!0);const d=e.get("chaos");(d==="1"||d==="true")&&j(!0);const f=Number(e.get("chaosPercent")||"0");Number.isNaN(f)||F(Math.max(0,Math.min(100,f)));const x=Number(e.get("traceJitter")||"0");Number.isNaN(x)||L(Math.max(0,Math.min(1e4,x)));const E=e.get("topic");E&&r(E);const y=e.get("difficulty");["easy","medium","hard"].includes(y)&&k(y)}catch{}},[]);const Q=i.useMemo(()=>{const e={"Content-Type":"application/json"};return b&&(e["x-msw-no-defaults"]="1"),m&&m!=="none"&&(e["x-trace-fail"]=m),u&&u>0&&(e["x-trace-delay"]=String(u)),p&&p>0&&(e["x-trace-jitter"]=String(p)),e},[b,m,u,p]),Y=async()=>{H(!0),J(null),w(null),O(null);try{const e={...Q};if(C&&(!m||m==="none")&&Math.random()*100<M){const s=["recommendations","session","validate"],d=s[Math.floor(Math.random()*s.length)];e["x-trace-fail"]=d}const a=await fetch("/api/quiz/start",{method:"POST",headers:e,body:JSON.stringify({topic:o,difficulty:l})});if(J(a.status),a.ok){const c=await a.json();O(c)}else if((a.headers.get("content-type")||"").includes("application/json")){const s=await a.json();O(s),w((s==null?void 0:s.error)||`HTTP ${a.status}`)}else{const s=await a.text();w(s||`HTTP ${a.status}`)}}catch(e){w((e==null?void 0:e.message)||"Network error")}finally{H(!1)}};return t.createElement("div",{style:{padding:16,maxWidth:860}},t.createElement("h3",null,"Service-to-Service Orchestration Playground"),t.createElement("p",null,"Simulates a composite endpoint that orchestrates multiple services (profile → session → validation). Uses POST /api/quiz/start (MSW)."),t.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:12}},t.createElement(Z,null),t.createElement("label",{style:{marginLeft:"auto"}},t.createElement("input",{type:"checkbox",checked:b,onChange:e=>R(e.target.checked)})," ","No defaults (x-msw-no-defaults)"),t.createElement("label",null,t.createElement("input",{type:"checkbox",checked:C,onChange:e=>j(e.target.checked)})," ","Chaos (random fail)"),C&&t.createElement("label",{style:{display:"flex",gap:6,alignItems:"center"}},"%",t.createElement("input",{type:"number",min:0,max:100,value:M,onChange:e=>F(Math.max(0,Math.min(100,Number(e.target.value)||0))),style:{width:80}}))),t.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}},t.createElement("div",{style:{padding:12,border:"1px solid rgba(255,255,255,0.12)",borderRadius:8}},t.createElement("div",{style:{fontWeight:600,marginBottom:8}},"Request"),t.createElement(v,{label:"Topic"},t.createElement("input",{value:o,onChange:e=>r(e.target.value),placeholder:"e.g., math"})),t.createElement(v,{label:"Difficulty"},t.createElement("select",{value:l,onChange:e=>k(e.target.value)},t.createElement("option",null,"easy"),t.createElement("option",null,"medium"),t.createElement("option",null,"hard"))),t.createElement(v,{label:"Trace Fail At"},t.createElement("select",{"aria-label":"trace-fail",value:m,onChange:e=>I(e.target.value)},t.createElement("option",{value:"none"},"none"),t.createElement("option",{value:"recommendations"},"recommendations"),t.createElement("option",{value:"session"},"session"),t.createElement("option",{value:"validate"},"validate"))),t.createElement(v,{label:"Trace Delay (ms)"},t.createElement("input",{"aria-label":"trace-delay",type:"number",min:0,max:1e4,value:u,onChange:e=>P(Number(e.target.value)||0)})),t.createElement(v,{label:"Delay Jitter (ms)"},t.createElement("input",{"aria-label":"trace-jitter",type:"number",min:0,max:1e4,value:p,onChange:e=>L(Number(e.target.value)||0)})),t.createElement("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"}},t.createElement("button",{onClick:Y,disabled:N},N?"Starting…":"Start Orchestration"),t.createElement("button",{type:"button",onClick:async()=>{const a=["curl","-X","POST",`'${new URL("/api/quiz/start",window.location.origin).toString()}'`,"-H","'Content-Type: application/json'"];b&&a.push("-H","'x-msw-no-defaults: 1'"),m&&m!=="none"&&a.push("-H",`'x-trace-fail: ${m}'`),u&&u>0&&a.push("-H",`'x-trace-delay: ${u}'`),p&&p>0&&a.push("-H",`'x-trace-jitter: ${p}'`);const c=JSON.stringify({topic:o,difficulty:l});a.push("-d",`'${c.replace(/'/g,"'\\''")}'`);try{await navigator.clipboard.writeText(a.join(" "))}catch{}}},"Copy cURL (request)"),t.createElement("button",{type:"button",onClick:()=>{const e=new URLSearchParams;e.set("traceFail","none"),e.set("topic",o),e.set("difficulty",l),window.location.search=e.toString()}},"Happy"),t.createElement("button",{type:"button",onClick:()=>{const e=new URLSearchParams;e.set("traceFail","validate"),e.set("traceDelay","300"),e.set("noDefaults","1"),e.set("topic",o),e.set("difficulty",l),window.location.search=e.toString()}},"Validate Failure"),t.createElement("button",{type:"button",onClick:()=>{const e=new URLSearchParams;e.set("chaos","1"),e.set("chaosPercent",String(50)),e.set("traceJitter","500"),e.set("topic",o),e.set("difficulty",l),window.location.search=e.toString()}},"Chaos Demo"))),t.createElement("div",{style:{padding:12,border:"1px solid rgba(255,255,255,0.12)",borderRadius:8}},t.createElement("div",{style:{fontWeight:600,marginBottom:8}},"Response"),t.createElement("div",null,"Status: ",K??"-"),g&&t.createElement("div",{style:{color:"#ff6b6b"}},g),n&&t.createElement(t.Fragment,null,t.createElement("div",{style:{marginBottom:6,fontWeight:600}},"Trace"),t.createElement("ul",{style:{marginTop:0}},(n.trace||[]).map((e,a)=>{const c=e.status>=500?"#ff6b6b":"#d7e0ff";return t.createElement("li",{key:a,style:{color:c}},t.createElement("code",null,e.step)," • ",e.service," • ",e.status)})),t.createElement("div",{style:{marginTop:8,fontWeight:600}},"Payload"),t.createElement("pre",{style:{fontFamily:"monospace",whiteSpace:"pre-wrap"}},JSON.stringify(n,null,2))),!g&&!n&&!N&&t.createElement("div",null,'Click \\"Start Orchestration\\" to run.')),t.createElement("div",{style:{padding:12,border:"1px solid rgba(255,255,255,0.12)",borderRadius:8}},t.createElement("div",{style:{fontWeight:600,marginBottom:8}},"DB Writes Preview (simulated)"),(()=>{var f;const e=(n==null?void 0:n.sessionId)||"(pending)",a=((f=n==null?void 0:n.profile)==null?void 0:f.userId)||"demo-user",c=new Date().toISOString(),s={sessions:{insert:{userId:a,topic:o,difficulty:l,createdAt:c}},session_events:{insert:{type:"start",sessionId:e}},...Array.isArray(n==null?void 0:n.validation)?{validation:{log:n.validation}}:{},...g?{error_log:{message:g,trace:Array.isArray(n==null?void 0:n.trace)?n.trace:void 0}}:{}},d=async()=>{try{await navigator.clipboard.writeText(JSON.stringify(s,null,2))}catch{}};return t.createElement(t.Fragment,null,t.createElement("pre",{style:{fontFamily:"monospace",whiteSpace:"pre-wrap",maxHeight:240,overflow:"auto"}},JSON.stringify(s,null,2)),t.createElement("div",{style:{display:"flex",gap:8}},t.createElement("button",{onClick:d},"Copy JSON"),t.createElement("button",{onClick:()=>{try{const x=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),E=URL.createObjectURL(x),y=document.createElement("a");y.href=E,y.download="db-preview.json",y.click(),URL.revokeObjectURL(E)}catch{}}},"Export JSON")))})(),t.createElement("div",{style:{fontSize:12,opacity:.8,marginTop:8}},"Note: This preview illustrates intended writes for the orchestrated flow."))))}const re={title:"Dev/S2S Orchestration",component:ee,parameters:{docs:{description:{component:"Composite S2S orchestration over POST /api/quiz/start with trace controls and failure injection."}}}},S={play:async({canvasElement:o})=>{const r=G(o),l=r.getByLabelText("trace-fail");await D.selectOptions(l,"none"),await D.click(r.getByRole("button",{name:/start orchestration/i})),await h(r.getByText(/status: 200/i)).toBeInTheDocument(),await h(r.getByText(/recommendations/i)).toBeInTheDocument(),await h(r.getByText(/validate:batch/i)).toBeInTheDocument()}},T={play:async({canvasElement:o})=>{const r=G(o),l=r.getByLabelText("trace-fail");await D.selectOptions(l,"validate"),await D.click(r.getByRole("button",{name:/start orchestration/i})),await h(r.getByText(/status: 500/i)).toBeInTheDocument(),await h(r.getByText(/validate:batch/i)).toBeInTheDocument(),await h(r.getByText(/trace failure/i)).toBeInTheDocument()}},B={};var U,W,$;S.parameters={...S.parameters,docs:{...(U=S.parameters)==null?void 0:U.docs,source:{originalSource:`{
  play: async ({
    canvasElement
  }) => {
    const c = within(canvasElement);
    const select = c.getByLabelText('trace-fail') as HTMLSelectElement;
    await userEvent.selectOptions(select, 'none');
    await userEvent.click(c.getByRole('button', {
      name: /start orchestration/i
    }));
    await expect(c.getByText(/status: 200/i)).toBeInTheDocument();
    await expect(c.getByText(/recommendations/i)).toBeInTheDocument();
    await expect(c.getByText(/validate:batch/i)).toBeInTheDocument();
  }
}`,...($=(W=S.parameters)==null?void 0:W.docs)==null?void 0:$.source}}};var q,z,A;T.parameters={...T.parameters,docs:{...(q=T.parameters)==null?void 0:q.docs,source:{originalSource:`{
  play: async ({
    canvasElement
  }) => {
    const c = within(canvasElement);
    const select = c.getByLabelText('trace-fail') as HTMLSelectElement;
    await userEvent.selectOptions(select, 'validate');
    await userEvent.click(c.getByRole('button', {
      name: /start orchestration/i
    }));
    await expect(c.getByText(/status: 500/i)).toBeInTheDocument();
    await expect(c.getByText(/validate:batch/i)).toBeInTheDocument();
    await expect(c.getByText(/trace failure/i)).toBeInTheDocument();
  }
}`,...(A=(z=T.parameters)==null?void 0:z.docs)==null?void 0:A.source}}};var _,V,X;B.parameters={...B.parameters,docs:{...(_=B.parameters)==null?void 0:_.docs,source:{originalSource:"{}",...(X=(V=B.parameters)==null?void 0:V.docs)==null?void 0:X.source}}};const se=["HappyPath","ValidateFailure","Default"];export{B as Default,S as HappyPath,T as ValidateFailure,se as __namedExportsOrder,re as default};
