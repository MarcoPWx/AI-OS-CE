import{R as e,r as T}from"./index-R2V08a_e.js";import{C as l,a as u,b as I,c as b}from"./card-z-SUCQbr.js";import{c as s,Z as A}from"./zap-C9ysjAC6.js";import{C as j,S as P,A as R}from"./shield-DlgAo2XN.js";const x=({children:n,variant:a="default",className:r=""})=>{const o="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold",i={default:"bg-gray-200 text-gray-800",secondary:"bg-gray-100 text-gray-600",destructive:"bg-red-100 text-red-700",outline:"border border-current text-gray-700"};return e.createElement("span",{className:`${o} ${i[a]||""} ${r}`},n)},d=({children:n,variant:a="default",size:r="md",className:o="",...i})=>{const y="inline-flex items-center justify-center rounded-md font-medium transition-colors",g={default:"bg-blue-600 text-white hover:bg-blue-700",outline:"border border-gray-300 text-gray-800 hover:bg-gray-50",ghost:"text-gray-800 hover:bg-gray-50"},S={sm:"px-2 py-1 text-sm",md:"px-3 py-2 text-sm"};return e.createElement("button",{className:`${y} ${g[a]||""} ${S[r]} ${o}`,...i},n)},$=({className:n="",icon:a,...r})=>e.createElement("div",{className:`relative ${n}`},a&&e.createElement("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"},a),e.createElement("input",{className:`w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 ${a?"pl-8":""}`,...r})),N=e.createContext({}),K=({value:n,onValueChange:a,children:r})=>e.createElement(N.Provider,{value:{value:n,onValueChange:a}},r),W=({className:n="",children:a})=>e.createElement("div",{className:`inline-flex items-center justify-between rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ${n}`},a),Y=({placeholder:n})=>{const{value:a}=e.useContext(N);return e.createElement("span",{className:"text-gray-700"},a||n||"")},Z=({children:n})=>e.createElement("div",{className:"mt-2 rounded-md border border-gray-200 bg-white p-1 shadow-sm"},n),c=({value:n,children:a})=>{const{onValueChange:r}=e.useContext(N);return e.createElement("div",{role:"option",className:"cursor-pointer rounded px-2 py-1 text-sm hover:bg-gray-100",onClick:()=>r&&r(n)},a)};/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],J=s("database",X);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],te=s("download",ee);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],ae=s("lock",ne);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],se=s("refresh-cw",re);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],oe=s("search",ie);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]],le=s("server",ce);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],de=s("triangle-alert",ue);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],pe=s("user",me),he=()=>{const[n,a]=T.useState("all"),[r,o]=T.useState(""),i=[{id:"1",timestamp:new Date("2024-01-15T10:30:00"),type:"USER_ACTION",action:"QUIZ_COMPLETED",userId:"user123",severity:"INFO",details:{quizId:"quiz789",score:85,xpEarned:45},ip:"192.168.1.100",s2sPublished:!0},{id:"2",timestamp:new Date("2024-01-15T10:25:00"),type:"SECURITY_ALERT",action:"MULTIPLE_FAILED_LOGINS",userId:"user456",severity:"HIGH",details:{attempts:5,blocked:!0},ip:"10.0.0.50",s2sPublished:!0},{id:"3",timestamp:new Date("2024-01-15T10:20:00"),type:"SYSTEM_EVENT",action:"SERVICE_RESTART",severity:"MEDIUM",details:{service:"gamification",reason:"deployment"},s2sPublished:!0},{id:"4",timestamp:new Date("2024-01-15T10:15:00"),type:"API_CALL",action:"S2S_EVENT_BATCH",severity:"INFO",details:{batchSize:50,duration:"45ms",success:!0},s2sPublished:!1},{id:"5",timestamp:new Date("2024-01-15T10:10:00"),type:"USER_ACTION",action:"ACHIEVEMENT_EARNED",userId:"user123",severity:"INFO",details:{achievement:"Week Warrior",xpReward:150},ip:"192.168.1.100",s2sPublished:!0}],y=[{title:"Total Events (24h)",value:"12,456",change:12,icon:e.createElement(R,{className:"h-5 w-5"}),color:"text-blue-500"},{title:"Security Alerts",value:23,change:-15,icon:e.createElement(P,{className:"h-5 w-5"}),color:"text-red-500"},{title:"S2S Success Rate",value:"99.7%",change:.2,icon:e.createElement(A,{className:"h-5 w-5"}),color:"text-green-500"},{title:"Queue Depth",value:156,icon:e.createElement(J,{className:"h-5 w-5"}),color:"text-purple-500"}],g=t=>{const f={INFO:"default",LOW:"secondary",MEDIUM:"outline",HIGH:"destructive",CRITICAL:"destructive"},G={INFO:"",LOW:"",MEDIUM:"border-yellow-500 text-yellow-700",HIGH:"",CRITICAL:"animate-pulse"};return e.createElement(x,{variant:f[t],className:G[t]},t)},S=t=>{switch(t){case"USER_ACTION":return e.createElement(pe,{className:"h-4 w-4"});case"SYSTEM_EVENT":return e.createElement(le,{className:"h-4 w-4"});case"SECURITY_ALERT":return e.createElement(ae,{className:"h-4 w-4"});case"API_CALL":return e.createElement(A,{className:"h-4 w-4"});default:return null}},C=i.filter(t=>!(n!=="all"&&t.type!==n||r&&!JSON.stringify(t).toLowerCase().includes(r.toLowerCase())));return e.createElement("div",{className:"p-6 max-w-7xl mx-auto space-y-6"},e.createElement("div",{className:"flex justify-between items-center"},e.createElement("div",null,e.createElement("h1",{className:"text-2xl font-bold"},"Audit Logging Dashboard"),e.createElement("p",{className:"text-muted-foreground"},"Real-time event monitoring and S2S publishing")),e.createElement("div",{className:"flex gap-2"},e.createElement(d,{variant:"outline",size:"sm"},e.createElement(se,{className:"h-4 w-4 mr-2"}),"Refresh"),e.createElement(d,{variant:"outline",size:"sm"},e.createElement(te,{className:"h-4 w-4 mr-2"}),"Export"))),e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4"},y.map((t,f)=>e.createElement(l,{key:f},e.createElement(u,{className:"p-6"},e.createElement("div",{className:"flex items-center justify-between"},e.createElement("div",null,e.createElement("p",{className:"text-sm text-muted-foreground"},t.title),e.createElement("p",{className:"text-2xl font-bold mt-1"},t.value),t.change!==void 0&&e.createElement("p",{className:`text-xs mt-1 ${t.change>0?"text-green-600":"text-red-600"}`},t.change>0?"↑":"↓"," ",Math.abs(t.change),"%")),e.createElement("div",{className:t.color},t.icon)))))),e.createElement(l,null,e.createElement(I,null,e.createElement(b,null,"Event Logs")),e.createElement(u,null,e.createElement("div",{className:"flex gap-4 mb-4"},e.createElement("div",{className:"flex-1"},e.createElement($,{placeholder:"Search logs...",value:r,onChange:t=>o(t.target.value),className:"w-full",icon:e.createElement(oe,{className:"h-4 w-4"})})),e.createElement(K,{value:n,onValueChange:a},e.createElement(W,{className:"w-[200px]"},e.createElement(Y,{placeholder:"Filter by type"})),e.createElement(Z,null,e.createElement(c,{value:"all"},"All Types"),e.createElement(c,{value:"USER_ACTION"},"User Actions"),e.createElement(c,{value:"SYSTEM_EVENT"},"System Events"),e.createElement(c,{value:"SECURITY_ALERT"},"Security Alerts"),e.createElement(c,{value:"API_CALL"},"API Calls")))),e.createElement("div",{className:"border rounded-lg overflow-hidden"},e.createElement("table",{className:"w-full"},e.createElement("thead",{className:"bg-muted/50"},e.createElement("tr",null,e.createElement("th",{className:"text-left p-3 font-medium"},"Time"),e.createElement("th",{className:"text-left p-3 font-medium"},"Type"),e.createElement("th",{className:"text-left p-3 font-medium"},"Action"),e.createElement("th",{className:"text-left p-3 font-medium"},"User"),e.createElement("th",{className:"text-left p-3 font-medium"},"Severity"),e.createElement("th",{className:"text-left p-3 font-medium"},"Details"),e.createElement("th",{className:"text-left p-3 font-medium"},"S2S"))),e.createElement("tbody",null,C.map(t=>e.createElement("tr",{key:t.id,className:"border-t hover:bg-muted/20 transition-colors"},e.createElement("td",{className:"p-3"},e.createElement("div",{className:"flex items-center gap-1 text-sm"},e.createElement(j,{className:"h-3 w-3 text-muted-foreground"}),t.timestamp.toLocaleTimeString())),e.createElement("td",{className:"p-3"},e.createElement("div",{className:"flex items-center gap-2"},S(t.type),e.createElement("span",{className:"text-sm"},t.type))),e.createElement("td",{className:"p-3 font-mono text-sm"},t.action),e.createElement("td",{className:"p-3 text-sm"},t.userId||"-"),e.createElement("td",{className:"p-3"},g(t.severity)),e.createElement("td",{className:"p-3"},e.createElement("details",{className:"cursor-pointer"},e.createElement("summary",{className:"text-sm text-muted-foreground"},"View details"),e.createElement("pre",{className:"text-xs mt-2 p-2 bg-muted rounded overflow-x-auto"},JSON.stringify(t.details,null,2)))),e.createElement("td",{className:"p-3"},t.s2sPublished?e.createElement(x,{variant:"outline",className:"text-green-600 border-green-600"},"Published"):e.createElement(x,{variant:"outline",className:"text-yellow-600 border-yellow-600"},"Queued"))))))),e.createElement("div",{className:"flex justify-between items-center mt-4"},e.createElement("p",{className:"text-sm text-muted-foreground"},"Showing ",C.length," of ",i.length," events"),e.createElement("div",{className:"flex gap-2"},e.createElement(d,{variant:"outline",size:"sm",disabled:!0},"Previous"),e.createElement(d,{variant:"outline",size:"sm"},"Next"))))),e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4"},e.createElement(l,null,e.createElement(I,null,e.createElement(b,{className:"flex items-center gap-2"},e.createElement(A,{className:"h-5 w-5"}),"S2S Event Queue")),e.createElement(u,null,e.createElement("div",{className:"space-y-3"},e.createElement("div",{className:"flex justify-between items-center"},e.createElement("span",{className:"text-sm"},"Main Queue"),e.createElement("span",{className:"font-mono text-sm"},"156 / 10,000")),e.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2"},e.createElement("div",{className:"bg-blue-500 h-2 rounded-full",style:{width:"1.56%"}})),e.createElement("div",{className:"flex justify-between items-center"},e.createElement("span",{className:"text-sm"},"Retry Queue"),e.createElement("span",{className:"font-mono text-sm"},"3 / 1,000")),e.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2"},e.createElement("div",{className:"bg-yellow-500 h-2 rounded-full",style:{width:"0.3%"}})),e.createElement("div",{className:"flex justify-between items-center"},e.createElement("span",{className:"text-sm"},"Dead Letter Queue"),e.createElement("span",{className:"font-mono text-sm"},"0 / 500")),e.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2"},e.createElement("div",{className:"bg-red-500 h-2 rounded-full",style:{width:"0%"}}))))),e.createElement(l,null,e.createElement(I,null,e.createElement(b,{className:"flex items-center gap-2"},e.createElement(de,{className:"h-5 w-5"}),"Active Alerts")),e.createElement(u,null,e.createElement("div",{className:"space-y-3"},e.createElement("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg"},e.createElement("div",{className:"flex items-start gap-2"},e.createElement(P,{className:"h-4 w-4 text-red-600 mt-0.5"}),e.createElement("div",{className:"flex-1"},e.createElement("p",{className:"text-sm font-semibold"},"Brute Force Attempt"),e.createElement("p",{className:"text-xs text-muted-foreground"},"5 failed login attempts from IP 10.0.0.50"),e.createElement("p",{className:"text-xs text-muted-foreground mt-1"},"2 minutes ago")))),e.createElement("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg"},e.createElement("div",{className:"flex items-start gap-2"},e.createElement(R,{className:"h-4 w-4 text-yellow-600 mt-0.5"}),e.createElement("div",{className:"flex-1"},e.createElement("p",{className:"text-sm font-semibold"},"High API Error Rate"),e.createElement("p",{className:"text-xs text-muted-foreground"},"Error rate at 12% (threshold: 10%)"),e.createElement("p",{className:"text-xs text-muted-foreground mt-1"},"5 minutes ago")))))))))},Se={title:"Infrastructure/Audit Logging",component:he,parameters:{layout:"fullscreen",docs:{description:{component:`
## 🔍 Audit Logging System

Enterprise-grade audit logging with S2S event publishing, real-time monitoring, and security alerting.

### System Architecture

\`\`\`
Event Source
    ↓
AuditLogService
    ├── Event Capture
    │   ├── User actions
    │   ├── System events
    │   ├── Security incidents
    │   └── API calls
    │
    ├── Event Processing
    │   ├── Validation
    │   ├── Enrichment
    │   ├── Classification
    │   └── Batching
    │
    ├── Storage Layer
    │   ├── In-memory buffer
    │   ├── Batch persistence
    │   └── Archive rotation
    │
    ├── S2S Publisher
    │   ├── Event formatting
    │   ├── Queue management
    │   ├── Retry logic
    │   └── Dead letter queue
    │
    └── Query Interface
        ├── Filter by type/user/date
        ├── Pagination
        ├── Export (JSON/CSV)
        └── Real-time streaming
\`\`\`

### Core Features

#### 📝 Event Types
- **USER_ACTION**: User-initiated events (login, quiz, profile)
- **SYSTEM_EVENT**: System operations (startup, shutdown, cron)
- **SECURITY_ALERT**: Security incidents (failed auth, suspicious activity)
- **API_CALL**: External API interactions (S2S, webhooks)
- **DATA_CHANGE**: Database modifications (CRUD operations)
- **PERFORMANCE**: Performance metrics (slow queries, timeouts)

#### 🚀 S2S Event Publishing
\`\`\`typescript
interface S2SEvent {
  eventId: string;
  timestamp: Date;
  serviceId: string;
  eventType: string;
  payload: Record<string, any>;
  metadata: {
    correlationId: string;
    causationId?: string;
    userId?: string;
    sessionId?: string;
  };
}
\`\`\`

#### 🔐 Security Features
- **Tamper Detection**: SHA-256 event hashing
- **Access Control**: Role-based query permissions
- **PII Protection**: Automatic data masking
- **Retention Policy**: Configurable data lifecycle
- **Compliance**: GDPR, SOC2, HIPAA ready

### Event Flow Example

\`\`\`typescript
// 1. User completes quiz
gamificationService.completeQuiz(userId, quizId, score)
  ↓
// 2. Audit log created
auditService.log({
  type: 'USER_ACTION',
  action: 'QUIZ_COMPLETED',
  userId,
  details: { quizId, score, duration }
})
  ↓
// 3. Event enriched
{
  ...event,
  timestamp: new Date(),
  sessionId: getSessionId(),
  ip: getClientIP(),
  userAgent: getUserAgent()
}
  ↓
// 4. S2S publish
s2sPublisher.publish({
  service: 'gamification',
  event: 'quiz.completed',
  payload: enrichedEvent
})
  ↓
// 5. Batch persistence
batchProcessor.add(enrichedEvent)
  → Flush every 100 events or 5 seconds
\`\`\`

### Query Capabilities

#### Advanced Filtering
\`\`\`typescript
// Complex query example
const logs = await auditService.query({
  types: ['SECURITY_ALERT', 'USER_ACTION'],
  users: ['user123', 'user456'],
  dateRange: {
    start: '2024-01-01',
    end: '2024-01-31'
  },
  actions: ['LOGIN_FAILED', 'PERMISSION_DENIED'],
  severity: ['HIGH', 'CRITICAL']
});
\`\`\`

#### Export Formats
- **JSON**: Full event details with metadata
- **CSV**: Flattened structure for Excel/BI tools
- **Syslog**: RFC 5424 format for SIEM integration
- **CEF**: Common Event Format for security tools

### Performance Optimization

#### Batching Strategy
- **Buffer Size**: 100 events max
- **Flush Interval**: 5 seconds
- **Compression**: GZIP for archives
- **Indexing**: Type, user, timestamp indexes

#### S2S Queue Management
\`\`\`
Main Queue (10,000 capacity)
    ↓ (Process)
Success → ACK & Delete
    ↓ (Failure)
Retry Queue (3 attempts)
    ↓ (Max retries)
Dead Letter Queue → Manual intervention
\`\`\`

### Monitoring & Alerting

#### Real-time Dashboards
- Event volume by type
- Error rate trends
- User activity heatmap
- Security incident tracker
- S2S publish success rate

#### Alert Conditions
- Failed login attempts > 5 in 1 minute
- API error rate > 10%
- S2S queue depth > 1000
- No events received for 5 minutes
- Unusual user behavior patterns
        `}}},tags:["autodocs"]},m={name:"System Overview"},p={name:"Event Type Reference",parameters:{docs:{description:{story:`
### Event Type Definitions

#### USER_ACTION Events
| Action | Description | Severity | S2S Event |
|--------|-------------|----------|-----------|
| LOGIN_SUCCESS | User login | INFO | auth.login |
| LOGIN_FAILED | Failed login | MEDIUM | auth.failed |
| LOGOUT | User logout | INFO | auth.logout |
| QUIZ_STARTED | Quiz begin | INFO | quiz.started |
| QUIZ_COMPLETED | Quiz end | INFO | quiz.completed |
| ACHIEVEMENT_EARNED | Achievement unlock | INFO | gamification.achievement |
| PROFILE_UPDATED | Profile change | INFO | user.updated |

#### SYSTEM_EVENT Events
| Event | Description | Severity | S2S Event |
|-------|-------------|----------|-----------|
| SERVICE_START | Service startup | INFO | system.start |
| SERVICE_STOP | Service shutdown | INFO | system.stop |
| CACHE_CLEAR | Cache cleared | INFO | system.cache |
| BACKUP_COMPLETE | Backup finished | INFO | system.backup |
| MIGRATION_RUN | DB migration | MEDIUM | system.migration |

#### SECURITY_ALERT Events
| Alert | Description | Severity | S2S Event |
|-------|-------------|----------|-----------|
| BRUTE_FORCE | Multiple failed logins | HIGH | security.brute_force |
| UNAUTHORIZED_ACCESS | Permission denied | HIGH | security.unauthorized |
| SUSPICIOUS_ACTIVITY | Anomaly detected | CRITICAL | security.anomaly |
| DATA_BREACH_ATTEMPT | Data access violation | CRITICAL | security.breach |
| SESSION_HIJACK | Session anomaly | CRITICAL | security.hijack |

#### API_CALL Events
| Call Type | Description | Severity | S2S Event |
|-----------|-------------|----------|-----------|
| S2S_REQUEST | Service call | INFO | api.s2s |
| WEBHOOK_RECEIVED | Webhook event | INFO | api.webhook |
| EXTERNAL_API | 3rd party call | INFO | api.external |
| RATE_LIMITED | Rate limit hit | MEDIUM | api.rate_limit |
| API_ERROR | API failure | HIGH | api.error |
        `}}}},h={name:"S2S Event Publishing",parameters:{docs:{description:{story:`
### S2S Event Publishing Architecture

#### Event Format
\`\`\`typescript
interface S2SEventPayload {
  // Event identification
  eventId: string;           // UUID v4
  eventType: string;          // Dot notation: service.action
  timestamp: string;          // ISO 8601
  version: string;            // Event schema version
  
  // Event source
  service: {
    id: string;             // Service identifier
    instance: string;       // Instance/pod ID
    environment: string;    // dev/staging/prod
  };
  
  // Event context
  context: {
    correlationId: string;  // Request correlation
    causationId?: string;   // Parent event ID
    userId?: string;        // User identifier
    sessionId?: string;     // Session identifier
    tenantId?: string;      // Multi-tenant ID
  };
  
  // Event data
  data: Record<string, any>;
  
  // Event metadata
  metadata: {
    retry: number;          // Retry attempt
    priority: 'LOW' | 'MEDIUM' | 'HIGH';
    ttl?: number;           // Time to live (seconds)
  };
}
\`\`\`

#### Publishing Flow
\`\`\`
1. Event Creation
   auditService.log(event)
        ↓
2. S2S Formatting
   formatter.toS2SEvent(event)
        ↓
3. Queue Addition
   publisher.queue.add(s2sEvent)
        ↓
4. Batch Processing
   [Batch of 50 events OR 5 second timeout]
        ↓
5. HTTP POST to S2S Endpoint
   POST /events/batch
   Content-Type: application/json
   X-Service-Auth: Bearer {token}
        ↓
6. Response Handling
   Success (200) → ACK & Delete from queue
   Failure (4xx/5xx) → Retry with backoff
        ↓
7. Dead Letter Queue
   After 3 retries → Move to DLQ for manual review
\`\`\`

#### Configuration
\`\`\`typescript
const s2sConfig = {
  endpoint: process.env.S2S_ENDPOINT,
  auth: {
    type: 'bearer',
    token: process.env.S2S_AUTH_TOKEN
  },
  batch: {
    size: 50,
    timeout: 5000  // 5 seconds
  },
  retry: {
    attempts: 3,
    backoff: 'exponential',
    maxDelay: 30000  // 30 seconds
  },
  queue: {
    maxSize: 10000,
    persistent: true,
    deadLetterQueue: true
  }
};
\`\`\`

#### Event Examples

**User Login Event**
\`\`\`json
{
  "eventId": "550e8400-e29b-41d4-a716-446655440000",
  "eventType": "auth.login.success",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0.0",
  "service": {
    "id": "quiz-mentor",
    "instance": "pod-abc123",
    "environment": "production"
  },
  "context": {
    "correlationId": "req-789xyz",
    "userId": "user-123",
    "sessionId": "sess-456"
  },
  "data": {
    "method": "password",
    "ip": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "mfa": true
  },
  "metadata": {
    "retry": 0,
    "priority": "MEDIUM"
  }
}
\`\`\`

**Quiz Completion Event**
\`\`\`json
{
  "eventId": "660e8400-e29b-41d4-a716-446655440001",
  "eventType": "gamification.quiz.completed",
  "timestamp": "2024-01-15T10:35:00Z",
  "version": "1.0.0",
  "service": {
    "id": "quiz-mentor",
    "instance": "pod-abc123",
    "environment": "production"
  },
  "context": {
    "correlationId": "req-789xyz",
    "causationId": "550e8400-e29b-41d4-a716-446655440000",
    "userId": "user-123",
    "sessionId": "sess-456"
  },
  "data": {
    "quizId": "quiz-789",
    "score": 85,
    "duration": 120,
    "difficulty": "HARD",
    "xpEarned": 45,
    "achievements": ["speed_demon"]
  },
  "metadata": {
    "retry": 0,
    "priority": "LOW"
  }
}
\`\`\`
        `}}}},v={name:"Security & Compliance",parameters:{docs:{description:{story:`
### 🔐 Security Monitoring

#### Threat Detection Rules

**Brute Force Attack**
\`\`\`typescript
if (failedLogins.count > 5 && failedLogins.timeWindow < 60) {
  alert({
    type: 'BRUTE_FORCE',
    severity: 'HIGH',
    user: failedLogins.userId,
    action: 'BLOCK_IP'
  });
}
\`\`\`

**Anomaly Detection**
\`\`\`typescript
// Unusual login location
if (distance(currentLocation, lastLocation) > 1000km &&
    timeDiff < 1hour) {
  alert({
    type: 'IMPOSSIBLE_TRAVEL',
    severity: 'CRITICAL'
  });
}

// Unusual activity pattern
if (actionsPerMinute > userBaseline * 5) {
  alert({
    type: 'UNUSUAL_ACTIVITY',
    severity: 'HIGH'
  });
}
\`\`\`

#### Compliance Features

**GDPR Compliance**
- Right to erasure (data deletion)
- Data portability (export)
- Consent tracking
- PII encryption
- Audit trail of data access

**SOC2 Type II**
- Access controls
- Change monitoring
- Availability tracking
- Data integrity checks
- Incident response logs

**HIPAA (if applicable)**
- PHI access logging
- Encryption at rest
- User activity monitoring
- System access reviews
- Breach notification logs

#### Data Protection

**PII Masking**
\`\`\`typescript
// Before logging
{
  email: "user@example.com",
  ssn: "123-45-6789",
  creditCard: "4111-1111-1111-1111"
}

// After masking
{
  email: "u***@example.com",
  ssn: "XXX-XX-6789",
  creditCard: "4111-****-****-1111"
}
\`\`\`

**Encryption**
- At rest: AES-256
- In transit: TLS 1.3
- Key rotation: 90 days
- HSM integration available

#### Retention Policies

| Data Type | Retention | Archive | Deletion |
|-----------|-----------|---------|----------|
| Security alerts | 7 years | After 1 year | Permanent |
| User actions | 2 years | After 6 months | Soft delete |
| System events | 1 year | After 3 months | Permanent |
| API calls | 90 days | After 30 days | Permanent |
| Performance | 30 days | No | Permanent |

#### Incident Response

**Automated Response Actions**
1. IP blocking for brute force
2. Session termination for hijacking
3. Account lockout for suspicious activity
4. Alert to security team
5. Forensic data capture

**Manual Review Queue**
- Dead letter queue events
- Critical security alerts
- Compliance violations
- Data breach attempts
- Unusual patterns

#### Reporting

**Security Dashboard**
- Failed login attempts (24h)
- Active threats
- Blocked IPs
- User risk scores
- Compliance status

**Compliance Reports**
- Monthly access reviews
- Quarterly security audits
- Annual compliance attestation
- Incident response metrics
- Data retention compliance
        `}}}},E={name:"Technical Implementation",parameters:{docs:{description:{story:`
### 🛠️ Implementation Details

#### Service Architecture
\`\`\`typescript
// src/services/audit/AuditLogService.ts

export class AuditLogService {
  private logs: AuditLog[] = [];
  private batchProcessor: BatchProcessor;
  private s2sPublisher: S2SEventPublisher;
  
  constructor(
    private readonly config: AuditConfig,
    private readonly storage: StorageAdapter,
    private readonly publisher: EventPublisher
  ) {
    this.batchProcessor = new BatchProcessor(config.batch);
    this.s2sPublisher = new S2SEventPublisher(config.s2s);
  }
  
  async log(event: AuditEvent): Promise<void> {
    // 1. Validate event
    this.validateEvent(event);
    
    // 2. Enrich with metadata
    const enriched = this.enrichEvent(event);
    
    // 3. Add to batch
    this.batchProcessor.add(enriched);
    
    // 4. Publish to S2S
    await this.s2sPublisher.publish(enriched);
    
    // 5. Check for security alerts
    this.checkSecurityRules(enriched);
  }
  
  async query(filters: QueryFilters): Promise<PagedResult> {
    return this.storage.query(filters);
  }
  
  async export(format: ExportFormat): Promise<Buffer> {
    const exporter = ExporterFactory.create(format);
    return exporter.export(this.logs);
  }
}
\`\`\`

#### Batch Processing
\`\`\`typescript
class BatchProcessor {
  private batch: AuditLog[] = [];
  private timer: NodeJS.Timeout;
  
  constructor(private config: BatchConfig) {
    this.startTimer();
  }
  
  add(event: AuditLog): void {
    this.batch.push(event);
    
    if (this.batch.length >= this.config.size) {
      this.flush();
    }
  }
  
  private async flush(): Promise<void> {
    if (this.batch.length === 0) return;
    
    const toFlush = [...this.batch];
    this.batch = [];
    
    try {
      await this.storage.batchInsert(toFlush);
    } catch (error) {
      // Add back to batch for retry
      this.batch.unshift(...toFlush);
      throw error;
    }
  }
  
  private startTimer(): void {
    this.timer = setInterval(() => {
      this.flush();
    }, this.config.flushInterval);
  }
}
\`\`\`

#### S2S Publisher
\`\`\`typescript
class S2SEventPublisher {
  private queue: Queue<S2SEvent>;
  private deadLetterQueue: Queue<S2SEvent>;
  
  constructor(private config: S2SConfig) {
    this.queue = new Queue(config.queue);
    this.deadLetterQueue = new Queue(config.dlq);
  }
  
  async publish(event: AuditLog): Promise<void> {
    const s2sEvent = this.formatEvent(event);
    await this.queue.add(s2sEvent);
  }
  
  private async processQueue(): Promise<void> {
    const batch = await this.queue.take(this.config.batchSize);
    
    try {
      await this.sendBatch(batch);
      await this.queue.ack(batch);
    } catch (error) {
      await this.handleFailure(batch, error);
    }
  }
  
  private async sendBatch(events: S2SEvent[]): Promise<void> {
    const response = await fetch(this.config.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${this.config.token}\`
      },
      body: JSON.stringify({ events })
    });
    
    if (!response.ok) {
      throw new Error(\`S2S publish failed: \${response.status}\`);
    }
  }
  
  private async handleFailure(
    events: S2SEvent[],
    error: Error
  ): Promise<void> {
    for (const event of events) {
      if (event.retries >= this.config.maxRetries) {
        await this.deadLetterQueue.add(event);
      } else {
        event.retries++;
        await this.queue.add(event, {
          delay: this.calculateBackoff(event.retries)
        });
      }
    }
  }
}
\`\`\`

#### Testing Strategy

**Unit Tests**
\`\`\`typescript
describe('AuditLogService', () => {
  it('should batch events correctly', async () => {
    const service = new AuditLogService(config);
    
    // Add 99 events
    for (let i = 0; i < 99; i++) {
      await service.log(createEvent());
    }
    
    // Should not flush yet
    expect(mockStorage.batchInsert).not.toHaveBeenCalled();
    
    // Add 100th event
    await service.log(createEvent());
    
    // Should trigger flush
    expect(mockStorage.batchInsert).toHaveBeenCalledWith(
      expect.arrayContaining([expect.any(Object)])
    );
  });
  
  it('should handle S2S failures gracefully', async () => {
    const service = new AuditLogService(config);
    mockFetch.mockRejectedValue(new Error('Network error'));
    
    await service.log(createEvent());
    
    // Should add to retry queue
    expect(mockQueue.add).toHaveBeenCalledWith(
      expect.objectContaining({ retries: 1 })
    );
  });
});
\`\`\`

#### Performance Considerations

**Optimization Techniques**
1. **Batch Processing**: Reduce I/O operations
2. **Async Queue**: Non-blocking event publishing
3. **Connection Pooling**: Reuse HTTP connections
4. **Compression**: GZIP for large payloads
5. **Indexing**: Optimize query performance

**Benchmarks**
- Event logging: < 1ms (async)
- Batch flush: < 100ms (100 events)
- Query (1M events): < 500ms
- Export (10K events): < 2s
- S2S publish: < 50ms (per batch)

**Scalability**
- Horizontal scaling via service instances
- Partitioned storage by date/type
- Distributed queue with Redis/Kafka
- Read replicas for queries
- CDN for exported reports
        `}}}};var w,L,D;m.parameters={...m.parameters,docs:{...(w=m.parameters)==null?void 0:w.docs,source:{originalSource:`{
  name: 'System Overview'
}`,...(D=(L=m.parameters)==null?void 0:L.docs)==null?void 0:D.source}}};var O,_,k;p.parameters={...p.parameters,docs:{...(O=p.parameters)==null?void 0:O.docs,source:{originalSource:`{
  name: 'Event Type Reference',
  parameters: {
    docs: {
      description: {
        story: \`
### Event Type Definitions

#### USER_ACTION Events
| Action | Description | Severity | S2S Event |
|--------|-------------|----------|-----------|
| LOGIN_SUCCESS | User login | INFO | auth.login |
| LOGIN_FAILED | Failed login | MEDIUM | auth.failed |
| LOGOUT | User logout | INFO | auth.logout |
| QUIZ_STARTED | Quiz begin | INFO | quiz.started |
| QUIZ_COMPLETED | Quiz end | INFO | quiz.completed |
| ACHIEVEMENT_EARNED | Achievement unlock | INFO | gamification.achievement |
| PROFILE_UPDATED | Profile change | INFO | user.updated |

#### SYSTEM_EVENT Events
| Event | Description | Severity | S2S Event |
|-------|-------------|----------|-----------|
| SERVICE_START | Service startup | INFO | system.start |
| SERVICE_STOP | Service shutdown | INFO | system.stop |
| CACHE_CLEAR | Cache cleared | INFO | system.cache |
| BACKUP_COMPLETE | Backup finished | INFO | system.backup |
| MIGRATION_RUN | DB migration | MEDIUM | system.migration |

#### SECURITY_ALERT Events
| Alert | Description | Severity | S2S Event |
|-------|-------------|----------|-----------|
| BRUTE_FORCE | Multiple failed logins | HIGH | security.brute_force |
| UNAUTHORIZED_ACCESS | Permission denied | HIGH | security.unauthorized |
| SUSPICIOUS_ACTIVITY | Anomaly detected | CRITICAL | security.anomaly |
| DATA_BREACH_ATTEMPT | Data access violation | CRITICAL | security.breach |
| SESSION_HIJACK | Session anomaly | CRITICAL | security.hijack |

#### API_CALL Events
| Call Type | Description | Severity | S2S Event |
|-----------|-------------|----------|-----------|
| S2S_REQUEST | Service call | INFO | api.s2s |
| WEBHOOK_RECEIVED | Webhook event | INFO | api.webhook |
| EXTERNAL_API | 3rd party call | INFO | api.external |
| RATE_LIMITED | Rate limit hit | MEDIUM | api.rate_limit |
| API_ERROR | API failure | HIGH | api.error |
        \`
      }
    }
  }
}`,...(k=(_=p.parameters)==null?void 0:_.docs)==null?void 0:k.source}}};var U,M,F;h.parameters={...h.parameters,docs:{...(U=h.parameters)==null?void 0:U.docs,source:{originalSource:`{
  name: 'S2S Event Publishing',
  parameters: {
    docs: {
      description: {
        story: \`
### S2S Event Publishing Architecture

#### Event Format
\\\`\\\`\\\`typescript
interface S2SEventPayload {
  // Event identification
  eventId: string;           // UUID v4
  eventType: string;          // Dot notation: service.action
  timestamp: string;          // ISO 8601
  version: string;            // Event schema version
  
  // Event source
  service: {
    id: string;             // Service identifier
    instance: string;       // Instance/pod ID
    environment: string;    // dev/staging/prod
  };
  
  // Event context
  context: {
    correlationId: string;  // Request correlation
    causationId?: string;   // Parent event ID
    userId?: string;        // User identifier
    sessionId?: string;     // Session identifier
    tenantId?: string;      // Multi-tenant ID
  };
  
  // Event data
  data: Record<string, any>;
  
  // Event metadata
  metadata: {
    retry: number;          // Retry attempt
    priority: 'LOW' | 'MEDIUM' | 'HIGH';
    ttl?: number;           // Time to live (seconds)
  };
}
\\\`\\\`\\\`

#### Publishing Flow
\\\`\\\`\\\`
1. Event Creation
   auditService.log(event)
        ↓
2. S2S Formatting
   formatter.toS2SEvent(event)
        ↓
3. Queue Addition
   publisher.queue.add(s2sEvent)
        ↓
4. Batch Processing
   [Batch of 50 events OR 5 second timeout]
        ↓
5. HTTP POST to S2S Endpoint
   POST /events/batch
   Content-Type: application/json
   X-Service-Auth: Bearer {token}
        ↓
6. Response Handling
   Success (200) → ACK & Delete from queue
   Failure (4xx/5xx) → Retry with backoff
        ↓
7. Dead Letter Queue
   After 3 retries → Move to DLQ for manual review
\\\`\\\`\\\`

#### Configuration
\\\`\\\`\\\`typescript
const s2sConfig = {
  endpoint: process.env.S2S_ENDPOINT,
  auth: {
    type: 'bearer',
    token: process.env.S2S_AUTH_TOKEN
  },
  batch: {
    size: 50,
    timeout: 5000  // 5 seconds
  },
  retry: {
    attempts: 3,
    backoff: 'exponential',
    maxDelay: 30000  // 30 seconds
  },
  queue: {
    maxSize: 10000,
    persistent: true,
    deadLetterQueue: true
  }
};
\\\`\\\`\\\`

#### Event Examples

**User Login Event**
\\\`\\\`\\\`json
{
  "eventId": "550e8400-e29b-41d4-a716-446655440000",
  "eventType": "auth.login.success",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0.0",
  "service": {
    "id": "quiz-mentor",
    "instance": "pod-abc123",
    "environment": "production"
  },
  "context": {
    "correlationId": "req-789xyz",
    "userId": "user-123",
    "sessionId": "sess-456"
  },
  "data": {
    "method": "password",
    "ip": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "mfa": true
  },
  "metadata": {
    "retry": 0,
    "priority": "MEDIUM"
  }
}
\\\`\\\`\\\`

**Quiz Completion Event**
\\\`\\\`\\\`json
{
  "eventId": "660e8400-e29b-41d4-a716-446655440001",
  "eventType": "gamification.quiz.completed",
  "timestamp": "2024-01-15T10:35:00Z",
  "version": "1.0.0",
  "service": {
    "id": "quiz-mentor",
    "instance": "pod-abc123",
    "environment": "production"
  },
  "context": {
    "correlationId": "req-789xyz",
    "causationId": "550e8400-e29b-41d4-a716-446655440000",
    "userId": "user-123",
    "sessionId": "sess-456"
  },
  "data": {
    "quizId": "quiz-789",
    "score": 85,
    "duration": 120,
    "difficulty": "HARD",
    "xpEarned": 45,
    "achievements": ["speed_demon"]
  },
  "metadata": {
    "retry": 0,
    "priority": "LOW"
  }
}
\\\`\\\`\\\`
        \`
      }
    }
  }
}`,...(F=(M=h.parameters)==null?void 0:M.docs)==null?void 0:F.source}}};var H,B,q;v.parameters={...v.parameters,docs:{...(H=v.parameters)==null?void 0:H.docs,source:{originalSource:`{
  name: 'Security & Compliance',
  parameters: {
    docs: {
      description: {
        story: \`
### 🔐 Security Monitoring

#### Threat Detection Rules

**Brute Force Attack**
\\\`\\\`\\\`typescript
if (failedLogins.count > 5 && failedLogins.timeWindow < 60) {
  alert({
    type: 'BRUTE_FORCE',
    severity: 'HIGH',
    user: failedLogins.userId,
    action: 'BLOCK_IP'
  });
}
\\\`\\\`\\\`

**Anomaly Detection**
\\\`\\\`\\\`typescript
// Unusual login location
if (distance(currentLocation, lastLocation) > 1000km &&
    timeDiff < 1hour) {
  alert({
    type: 'IMPOSSIBLE_TRAVEL',
    severity: 'CRITICAL'
  });
}

// Unusual activity pattern
if (actionsPerMinute > userBaseline * 5) {
  alert({
    type: 'UNUSUAL_ACTIVITY',
    severity: 'HIGH'
  });
}
\\\`\\\`\\\`

#### Compliance Features

**GDPR Compliance**
- Right to erasure (data deletion)
- Data portability (export)
- Consent tracking
- PII encryption
- Audit trail of data access

**SOC2 Type II**
- Access controls
- Change monitoring
- Availability tracking
- Data integrity checks
- Incident response logs

**HIPAA (if applicable)**
- PHI access logging
- Encryption at rest
- User activity monitoring
- System access reviews
- Breach notification logs

#### Data Protection

**PII Masking**
\\\`\\\`\\\`typescript
// Before logging
{
  email: "user@example.com",
  ssn: "123-45-6789",
  creditCard: "4111-1111-1111-1111"
}

// After masking
{
  email: "u***@example.com",
  ssn: "XXX-XX-6789",
  creditCard: "4111-****-****-1111"
}
\\\`\\\`\\\`

**Encryption**
- At rest: AES-256
- In transit: TLS 1.3
- Key rotation: 90 days
- HSM integration available

#### Retention Policies

| Data Type | Retention | Archive | Deletion |
|-----------|-----------|---------|----------|
| Security alerts | 7 years | After 1 year | Permanent |
| User actions | 2 years | After 6 months | Soft delete |
| System events | 1 year | After 3 months | Permanent |
| API calls | 90 days | After 30 days | Permanent |
| Performance | 30 days | No | Permanent |

#### Incident Response

**Automated Response Actions**
1. IP blocking for brute force
2. Session termination for hijacking
3. Account lockout for suspicious activity
4. Alert to security team
5. Forensic data capture

**Manual Review Queue**
- Dead letter queue events
- Critical security alerts
- Compliance violations
- Data breach attempts
- Unusual patterns

#### Reporting

**Security Dashboard**
- Failed login attempts (24h)
- Active threats
- Blocked IPs
- User risk scores
- Compliance status

**Compliance Reports**
- Monthly access reviews
- Quarterly security audits
- Annual compliance attestation
- Incident response metrics
- Data retention compliance
        \`
      }
    }
  }
}`,...(q=(B=v.parameters)==null?void 0:B.docs)==null?void 0:q.source}}};var Q,z,V;E.parameters={...E.parameters,docs:{...(Q=E.parameters)==null?void 0:Q.docs,source:{originalSource:`{
  name: 'Technical Implementation',
  parameters: {
    docs: {
      description: {
        story: \`
### 🛠️ Implementation Details

#### Service Architecture
\\\`\\\`\\\`typescript
// src/services/audit/AuditLogService.ts

export class AuditLogService {
  private logs: AuditLog[] = [];
  private batchProcessor: BatchProcessor;
  private s2sPublisher: S2SEventPublisher;
  
  constructor(
    private readonly config: AuditConfig,
    private readonly storage: StorageAdapter,
    private readonly publisher: EventPublisher
  ) {
    this.batchProcessor = new BatchProcessor(config.batch);
    this.s2sPublisher = new S2SEventPublisher(config.s2s);
  }
  
  async log(event: AuditEvent): Promise<void> {
    // 1. Validate event
    this.validateEvent(event);
    
    // 2. Enrich with metadata
    const enriched = this.enrichEvent(event);
    
    // 3. Add to batch
    this.batchProcessor.add(enriched);
    
    // 4. Publish to S2S
    await this.s2sPublisher.publish(enriched);
    
    // 5. Check for security alerts
    this.checkSecurityRules(enriched);
  }
  
  async query(filters: QueryFilters): Promise<PagedResult> {
    return this.storage.query(filters);
  }
  
  async export(format: ExportFormat): Promise<Buffer> {
    const exporter = ExporterFactory.create(format);
    return exporter.export(this.logs);
  }
}
\\\`\\\`\\\`

#### Batch Processing
\\\`\\\`\\\`typescript
class BatchProcessor {
  private batch: AuditLog[] = [];
  private timer: NodeJS.Timeout;
  
  constructor(private config: BatchConfig) {
    this.startTimer();
  }
  
  add(event: AuditLog): void {
    this.batch.push(event);
    
    if (this.batch.length >= this.config.size) {
      this.flush();
    }
  }
  
  private async flush(): Promise<void> {
    if (this.batch.length === 0) return;
    
    const toFlush = [...this.batch];
    this.batch = [];
    
    try {
      await this.storage.batchInsert(toFlush);
    } catch (error) {
      // Add back to batch for retry
      this.batch.unshift(...toFlush);
      throw error;
    }
  }
  
  private startTimer(): void {
    this.timer = setInterval(() => {
      this.flush();
    }, this.config.flushInterval);
  }
}
\\\`\\\`\\\`

#### S2S Publisher
\\\`\\\`\\\`typescript
class S2SEventPublisher {
  private queue: Queue<S2SEvent>;
  private deadLetterQueue: Queue<S2SEvent>;
  
  constructor(private config: S2SConfig) {
    this.queue = new Queue(config.queue);
    this.deadLetterQueue = new Queue(config.dlq);
  }
  
  async publish(event: AuditLog): Promise<void> {
    const s2sEvent = this.formatEvent(event);
    await this.queue.add(s2sEvent);
  }
  
  private async processQueue(): Promise<void> {
    const batch = await this.queue.take(this.config.batchSize);
    
    try {
      await this.sendBatch(batch);
      await this.queue.ack(batch);
    } catch (error) {
      await this.handleFailure(batch, error);
    }
  }
  
  private async sendBatch(events: S2SEvent[]): Promise<void> {
    const response = await fetch(this.config.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \\\`Bearer \\\${this.config.token}\\\`
      },
      body: JSON.stringify({ events })
    });
    
    if (!response.ok) {
      throw new Error(\\\`S2S publish failed: \\\${response.status}\\\`);
    }
  }
  
  private async handleFailure(
    events: S2SEvent[],
    error: Error
  ): Promise<void> {
    for (const event of events) {
      if (event.retries >= this.config.maxRetries) {
        await this.deadLetterQueue.add(event);
      } else {
        event.retries++;
        await this.queue.add(event, {
          delay: this.calculateBackoff(event.retries)
        });
      }
    }
  }
}
\\\`\\\`\\\`

#### Testing Strategy

**Unit Tests**
\\\`\\\`\\\`typescript
describe('AuditLogService', () => {
  it('should batch events correctly', async () => {
    const service = new AuditLogService(config);
    
    // Add 99 events
    for (let i = 0; i < 99; i++) {
      await service.log(createEvent());
    }
    
    // Should not flush yet
    expect(mockStorage.batchInsert).not.toHaveBeenCalled();
    
    // Add 100th event
    await service.log(createEvent());
    
    // Should trigger flush
    expect(mockStorage.batchInsert).toHaveBeenCalledWith(
      expect.arrayContaining([expect.any(Object)])
    );
  });
  
  it('should handle S2S failures gracefully', async () => {
    const service = new AuditLogService(config);
    mockFetch.mockRejectedValue(new Error('Network error'));
    
    await service.log(createEvent());
    
    // Should add to retry queue
    expect(mockQueue.add).toHaveBeenCalledWith(
      expect.objectContaining({ retries: 1 })
    );
  });
});
\\\`\\\`\\\`

#### Performance Considerations

**Optimization Techniques**
1. **Batch Processing**: Reduce I/O operations
2. **Async Queue**: Non-blocking event publishing
3. **Connection Pooling**: Reuse HTTP connections
4. **Compression**: GZIP for large payloads
5. **Indexing**: Optimize query performance

**Benchmarks**
- Event logging: < 1ms (async)
- Batch flush: < 100ms (100 events)
- Query (1M events): < 500ms
- Export (10K events): < 2s
- S2S publish: < 50ms (per batch)

**Scalability**
- Horizontal scaling via service instances
- Partitioned storage by date/type
- Distributed queue with Redis/Kafka
- Read replicas for queries
- CDN for exported reports
        \`
      }
    }
  }
}`,...(V=(z=E.parameters)==null?void 0:z.docs)==null?void 0:V.source}}};const fe=["Overview","EventTypes","S2SIntegration","SecurityMonitoring","Implementation"];export{p as EventTypes,E as Implementation,m as Overview,h as S2SIntegration,v as SecurityMonitoring,fe as __namedExportsOrder,Se as default};
